# Relay Server Makefile

.PHONY: build test clean help

# Default target
all: build

# Build the relay binary
build:
	@echo "üî® Building Relay..."
	go build -o relay

# Run the test suite
test: build
	@echo "üß™ Running Relay Test Suite..."
	cd test && go run *.go

# Build test runner
test-build:
	@echo "üî® Building test runner..."
	cd test && go build -o test_runner *.go

# Run quick smoke test
smoke-test: build
	@echo "üí® Running smoke test..."
	./relay --help || (echo "‚ùå Relay binary failed to run" && exit 1)
	@echo "‚úÖ Smoke test passed"

# Clean build artifacts
clean:
	@echo "üßπ Cleaning..."
	rm -f relay
	rm -f test/test_runner
	rm -f test/*.exe

# Install dependencies
deps:
	@echo "üì¶ Installing dependencies..."
	go mod tidy
	go mod download

# Format code
fmt:
	@echo "üé® Formatting code..."
	go fmt ./...

# Run linters
lint:
	@echo "üîç Running linters..."
	go vet ./...

# Full pipeline: clean, deps, format, lint, build, test
full: clean deps fmt lint build test

# Development mode - watch for changes and rebuild
dev:
	@echo "üëÄ Development mode (run 'make build' after changes)"
	@echo "Relay binary: ./relay"
	@echo "Test command: make test"

# Create a test project for manual testing
setup-test-project:
	@echo "üèóÔ∏è Setting up test project..."
	@if [ ! -d "/Users/reed/Code/Personal/RelayTest" ]; then \
		mkdir -p /Users/reed/Code/Personal/RelayTest; \
		cd /Users/reed/Code/Personal/RelayTest && git init; \
		echo "# RelayTest\n\nThis is a test repository for Relay Server." > README.md; \
		cd /Users/reed/Code/Personal/RelayTest && git add README.md; \
		cd /Users/reed/Code/Personal/RelayTest && git commit -m "Initial commit"; \
		echo "‚úÖ Created RelayTest repository"; \
	else \
		echo "‚úÖ RelayTest repository already exists"; \
	fi

# Run integration test with real RelayTest repo
integration-test: build setup-test-project
	@echo "üîó Running integration test..."
	./relay add -p "/Users/reed/Code/Personal/RelayTest" || true
	./relay list
	./relay open RelayTest || true
	./relay status || true
	./relay remove RelayTest || true
	@echo "‚úÖ Integration test completed"

# Performance test
perf-test: build
	@echo "‚ö° Running performance test..."
	@echo "Testing project operations..."
	time ./relay add -p "/Users/reed/Code/Personal/RelayTest" || true
	time ./relay list
	time ./relay open RelayTest || true
	time ./relay status || true
	time ./relay remove RelayTest || true

# CI/CD commands
ci-test:
	@echo "üöÄ Running CI-style tests..."
	@export CI_MODE=true && cd test && go run *.go

ci-setup:
	@echo "üîß Setting up CI-like environment..."
	@mkdir -p /tmp/RelayTest
	@cd /tmp/RelayTest && git init && git config user.name "CI Test" && git config user.email "ci@test.com"
	@echo "# CI Test Repo" > /tmp/RelayTest/README.md
	@cd /tmp/RelayTest && git add README.md && git commit -m "Initial commit"
	@echo "‚úÖ CI environment ready at /tmp/RelayTest"

pre-commit:
	@echo "üîç Running pre-commit checks..."
	@$(MAKE) fmt
	@$(MAKE) lint
	@$(MAKE) build
	@$(MAKE) test
	@echo "‚úÖ All pre-commit checks passed"

# Help
help:
	@echo "Relay Server Build System"
	@echo ""
	@echo "Available targets:"
	@echo "  build              Build the relay binary"
	@echo "  test               Run the full test suite"
	@echo "  smoke-test         Quick test to verify binary works"
	@echo "  clean              Remove build artifacts"
	@echo "  deps               Install Go dependencies"
	@echo "  fmt                Format Go code"
	@echo "  lint               Run code linters"
	@echo "  full               Run complete pipeline"
	@echo "  dev                Development mode info"
	@echo "  setup-test-project Create RelayTest repository"
	@echo "  integration-test   Manual integration test"
	@echo "  perf-test          Performance testing"
	@echo "  ci-test            Run tests in CI mode"
	@echo "  ci-setup           Set up CI-like environment"
	@echo "  pre-commit         Run all pre-commit checks"
	@echo "  help               Show this help message"
	@echo ""
	@echo "Usage examples:"
	@echo "  make build         # Build relay binary"
	@echo "  make test          # Run all tests"
	@echo "  make full          # Complete build and test"
	@echo "  make ci-test       # Test in CI mode"
	@echo "  make pre-commit    # Pre-commit validation"